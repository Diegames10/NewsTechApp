// static/js/index.api.js
(() => {
  const API = '/api/posts'; // se o index rodar fora do mesmo domínio, use a URL completa
  const $lista = document.getElementById('lista-noticias');
  const $vazio = document.getElementById('vazio');
  const $q = document.getElementById('q');
  const $ordem = document.getElementById('ordem');
  const $btnAtualizar = document.getElementById('btn-atualizar');
  const $paginacao = document.getElementById('paginacao');

  // estado local
  let posts = [];
  let filtrados = [];
  let pagina = 1;
  const POR_PAGINA = 10;

  const fmtData = (iso) => {
    try { return new Date(iso).toLocaleString(); } catch { return ''; }
  };

  const render = () => {
    // paginação
    const inicio = (pagina - 1) * POR_PAGINA;
    const fim = inicio + POR_PAGINA;
    const paginaItens = filtrados.slice(inicio, fim);

    if (!filtrados.length) {
      $lista.innerHTML = '';
      $vazio.style.display = 'block';
      $paginacao.innerHTML = '';
      return;
    }

    $vazio.style.display = 'none';

    $lista.innerHTML = paginaItens.map(p => `
      <article class="card-noticia" style="border:1px solid #e5e7eb;border-radius:12px;padding:14px;margin:0 0 12px 0;background:var(--bg);color:var(--text)">
        <h3 style="margin:.2rem 0">${p.titulo}</h3>
        <p style="margin:.2rem 0;color:#555"><small>por ${p.autor} • ${fmtData(p.criado_em)}</small></p>
        ${p.image_url ? `
          <img src="${p.image_url}" alt="imagem do post"
               style="max-width:100%;border-radius:10px;margin:.5rem 0">
        ` : ''}
        <p style="margin:.4rem 0 0 0">${p.conteudo}</p>
      </article>
    `).join('');

    // navegação de páginas
    const totalPaginas = Math.max(1, Math.ceil(filtrados.length / POR_PAGINA));
    const btn = (num, label = num) =>
      `<button class="btn ${num===pagina?'secondary':''}" data-page="${num}" ${num===pagina?'disabled':''} style="margin:2px 4px">${label}</button>`;

    const anterior = pagina > 1 ? btn(pagina - 1, '« Anterior') : '';
    const proxima  = pagina < totalPaginas ? btn(pagina + 1, 'Próxima »') : '';

    $paginacao.innerHTML = `
      <div style="display:flex;flex-wrap:wrap;gap:4px;align-items:center;justify-content:center;padding:8px 0">
        ${anterior}
        ${Array.from({length: totalPaginas}, (_,i) => btn(i+1)).join('')}
        ${proxima}
      </div>
    `;

    // listeners dos botões de página
    $paginacao.querySelectorAll('button[data-page]').forEach(b => {
      b.addEventListener('click', () => {
        pagina = parseInt(b.dataset.page, 10);
        render();
      });
    });
  };

  const aplicarFiltros = () => {
    const termo = ($q.value || '').trim().toLowerCase();

    // filtra
    filtrados = !termo ? [...posts] :
      posts.filter(p =>
        (p.titulo || '').toLowerCase().includes(termo) ||
        (p.conteudo || '').toLowerCase().includes(termo)
      );

    // ordena
    const ord = $ordem.value;
    filtrados.sort((a,b) => {
      if (ord === 'antigo') return (a.id||0) - (b.id||0);
      if (ord === 'titulo-az') return (a.titulo||'').localeCompare(b.titulo||'');
      if (ord === 'titulo-za') return (b.titulo||'').localeCompare(a.titulo||'');
      // padrão: recentes primeiro
      return (b.id||0) - (a.id||0);
    });

    // volta pra primeira página ao mudar filtro/ordem
    pagina = 1;
    render();
  };

  const carregar = async () => {
    $lista.innerHTML = `<p style="color:#666">Carregando…</p>`;
    try {
      // pegue mais itens de uma vez para filtrar no cliente
      const res = await fetch(`${API}?limit=50`);
      if (!res.ok) throw new Error('Falha ao carregar posts');
      posts = await res.json();
      aplicarFiltros();
    } catch (err) {
      console.error(err);
      $lista.innerHTML = `<p style="color:#b00">Erro ao carregar publicações.</p>`;
      $paginacao.innerHTML = '';
    }
  };

  // eventos
  $btnAtualizar.addEventListener('click', carregar);

  // pequena “delay” na busca pra não renderizar a cada tecla
  let t;
  $q.addEventListener('input', () => {
    clearTimeout(t);
    t = setTimeout(aplicarFiltros, 200);
  });

  $ordem.addEventListener('change', aplicarFiltros);

  // start
  carregar();
})();
